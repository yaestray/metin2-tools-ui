{% extends "base.html" %}

{% block title %}Quest functions · Metin2 Tools{% endblock %}

{% block content %}
<div class="quests-page py-3">
  <div class="row g-3">
    <!-- Левая колонка: структура -->
    <div class="col-lg-3">
      <div class="card bg-black border-secondary quests-sidebar">
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="text-uppercase text-muted small mb-0">Структура</h6>
          </div>

          <div class="quests-tree">
            <ul class="list-unstyled mb-0">
                {% for node in tree %}
                {% set _ = namespace(node=node) %} {# заглушка, чтобы явно было видно, что мы вносим node в контекст #}
                {% include "partials/quest_node.html" %}
                {% endfor %}
            </ul>
            </div>
        </div>
      </div>
    </div>

    <!-- Правая колонка: контент -->
    <div class="col-lg-9">
      <div class="card bg-black border-secondary quests-content">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
            <div>
              <div class="text-uppercase text-muted small mb-1">Quest functions</div>
              <h2 class="h4 mb-0">
                {{ title or 'Документация по квестам и Lua-функциям' }}
              </h2>
              {% if path %}
                <div class="small text-muted mt-1">
                  Путь: <code>{{ path }}</code>
                </div>
              {% endif %}
            </div>

            <!-- Поиск: отправляем GET на этот же /quests -->
            <form class="quests-search input-group input-group-sm" method="get">
              <input type="text"
                     class="form-control"
                     name="q"
                     placeholder="Поиск по названию и содержимому…"
                     value="{{ q or '' }}">
              <button class="btn btn-outline-light" type="submit">Найти</button>
            </form>
          </div>

          <hr class="border-secondary mb-3">

          <!-- Markdown-контент -->
          <div class="markdown-body quests-markdown">
            {{ html|safe }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const tree = document.querySelector('.quests-tree');
  if (!tree) return;

  tree.addEventListener('click', function (e) {
    const btn = e.target.closest('.quest-toggle');
    if (!btn) return;

    const node = btn.closest('.quest-node');
    if (!node) return;

    const children = node.querySelector(':scope > .quest-children');
    if (!children) return;

    const isCollapsed = children.classList.contains('collapsed');
    if (isCollapsed) {
      children.classList.remove('collapsed');
      node.classList.add('open');
    } else {
      children.classList.add('collapsed');
      node.classList.remove('open');
    }
  });
});
</script>
{% endblock %}